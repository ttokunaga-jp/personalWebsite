# バックエンド要件定義書

本ドキュメントは、個人ウェブサイトプロジェクトのバックエンドシステムの要件を定義する。

## 1. システム構成における役割

バックエンドシステムは、本ウェブサイトのデータ永続化、ビジネスロジック、および外部サービス連携を担当する。フロントエンドアプリケーション（React）からのリクエストに応じて、JSON形式のAPIを提供する。

また、サイト管理者向けの認証機能およびデータ管理機能を提供する責務を持つ。

## 2. 現行の実装から抽出した主要機能

### 2.1. APIエンドポイント提供

フロントエンドの各ページ（特に管理画面）で必要とされるデータを取得・更新するためのRESTful APIを提供する。

-   **ヘルスチェック:**
    -   APIサーバーの稼働状況を通知する。
-   **サイトコンテンツ管理:**
    -   `Home`ページ設定 (`HomeConfig`) の取得・更新。
    -   `Profile`情報 (`ProfileDocument`) の取得・更新。
-   **技術スタック管理:**
    -   `TechCatalog`（使用技術一覧）のCRUD操作。
-   **SNSリンク管理:**
    -   `SocialLink`（プロフィール等に表示するSNSリンク）のCRUD操作。
-   **予約・ミーティング管理:**
    -   `Reservation`（面談予約）の取得・管理。
    -   `MeetingUrl`（オンラインミーティングURL）の取得・更新。
    -   `Blacklist`（予約不可リスト）のCRUD操作。

### 2.2. 認証

-   Firebase Admin SDKを利用し、サイト管理者向けの認証（セッション管理）を行う。

### 2.3. データ永続化

-   **MySQL:**
    -   `sqlx`ライブラリを介して接続。主に構造化データ（予約、技術スタック等）の永続化に使用されると推測される。
-   **Google Cloud Firestore:**
    -   ドキュメントベースのデータ（プロフィール、サイト設定等）の永続化に使用されると推測される。

## 3. 外部依存関係

### 3.1. 言語・ランタイム

-   Go (v1.22)

### 3.2. フレームワーク・主要ライブラリ

| 役割             | ライブラリ名                               |
| :--------------- | :----------------------------------------- |
| Webフレームワーク  | `github.com/gin-gonic/gin`                 |
| DIコンテナ         | `go.uber.org/fx`                           |
| DB (MySQL)       | `github.com/go-sql-driver/mysql`, `github.com/jmoiron/sqlx` |
| DB (Firestore)   | `cloud.google.com/go/firestore`            |
| 認証             | `firebase.google.com/go/v4`                |
| 設定管理         | `github.com/spf13/viper`                   |
| CORS対応         | `github.com/gin-contrib/cors`              |
| UUID生成         | `github.com/google/uuid`                   |
| モニタリング     | `github.com/prometheus/client_golang`      |
| テスティング     | `github.com/stretchr/testify`              |

### 3.3. 外部サービス

-   Google Cloud Platform (Firestore)
-   Firebase (Authentication)
-   MySQLデータベースサーバー

## 4. データ構造・型定義

`backend/internal/model` ディレクトリに主要なデータモデルが定義されていると推測される。

-   `HomeConfig`: ホームページ表示内容の設定。
-   `ProfileDocument`: プロフィール情報。
-   `TechCatalogEntry`: 技術スタックの各項目。
-   `SocialLink`: SNSリンク情報。
-   `Reservation`: 面談予約情報。
-   `MeetingUrlTemplate`: オンラインミーティングURLのテンプレート。
-   `BlacklistEntry`: 予約ブラックリストの各項目。

## 5. 主な処理フロー・ユースケース

### 5.1. 管理者ログインフロー

1.  フロントエンドからログイン情報（ID/PW or トークン）を送信。
2.  バックエンドは`security`および`middleware`層でリクエストを検証。
3.  Firebase Admin SDKを用いて認証を行い、成功すればセッショントークンを生成・返却。
4.  以降の管理者向けAPIリクエストには、このトークンが必要となる。

### 5.2. 管理画面でのデータ更新フロー

1.  管理者権限を持つユーザーがフロントエンドの管理画面からデータ（例: 技術スタック）を更新。
2.  フロントエンドは対応するAPI（例: `PUT /api/admin/tech-catalog/{id}`）をリクエスト。
3.  `handler`層がリクエストを受信し、`service`層のビジネスロジックを呼び出す。
4.  `service`層は`repository`層を介して、MySQLまたはFirestoreのデータを更新する。
5.  処理結果を`handler`層に返し、JSONレスポンスとしてフロントエンドに返却。

## 6. 非機能要件

### 6.1. 可読性・保守性

-   `go.uber.org/fx`によるDIコンテナの導入や、`handler`, `service`, `repository`といったレイヤードアーキテクチャの採用から、高い関心事が伺える。

### 6.2. 拡張性

-   機能単位でのディレクトリ分割（`calendar`, `health`など）により、新規機能の追加が比較的容易な構造となっている。

### 6.3. セキュリティ

-   CORS設定（`gin-contrib/cors`）や認証ミドルウェアにより、APIのセキュリティが考慮されている。

### 6.4. モニタリング

-   `prometheus`クライアントの導入により、アプリケーションのメトリクス監視が意図されている。

## 7. 現行コードに基づく課題と改善ポイント

### 7.1. データベースの併用

-   MySQLとFirestoreという2種類のデータベースを併用しており、データの一貫性担保や運用が複雑化する可能性がある。どちらかに統一するか、明確な使い分けのドキュメント化が望まれる。

### 7.2. 設定管理

-   `viper`による設定管理が行われているが、設定ファイルの場所や環境ごとの切り替え方法が自明ではない。`config`ディレクトリの構造を解析し、規約を明確化する必要がある。

### 7.3. エラーハンドリング

-   `internal/errs`ディレクトリの存在から、独自のエラーハンドリング機構があると推測されるが、その詳細な仕様はコードリーディングが必要。API全体で一貫したエラーレスポンスが返せているか確認が必要。

### 7.4. テストカバレッジ

-   `testify`が導入されているものの、実際のテストコードの量やカバレッジは不明。特にビジネスロジック層（`service`）の単体テストが十分に書かれているか確認が必要。

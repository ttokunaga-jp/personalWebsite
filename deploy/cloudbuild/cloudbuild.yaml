timeout: 1800s
options:
  logging: CLOUD_LOGGING_ONLY
  substitutionOption: ALLOW_LOOSE
substitutions:
  _ENV: staging
  _REGION: asia-northeast1
  _ARTIFACT_REPO: personal-website
  _BACKEND_SERVICE: personal-website-api
  _FRONTEND_SERVICE: personal-website-frontend
  _VPC_CONNECTOR: ""
  _BACKEND_SERVICE_ACCOUNT: ""
  _FRONTEND_SERVICE_ACCOUNT: ""
  _BACKEND_SECRET_JWT: ""
  _BACKEND_SECRET_STATE: ""
  _BACKEND_SECRET_CSRF: ""
  _BACKEND_GOOGLE_CLIENT_ID: ""
  _BACKEND_SECRET_GOOGLE_CLIENT_SECRET: ""
  _BACKEND_SECRET_RECAPTCHA: ""
  _BACKEND_SECRET_ADMIN_ALLOWED_EMAILS: ""
  _BACKEND_SECRET_ADMIN_ALLOWED_DOMAINS: ""
  _FRONTEND_SECRET_RECAPTCHA: ""
  _FRONTEND_API_BASE_URL: ""
  _FIRESTORE_DATABASE_ID: "(default)"
  _FIRESTORE_COLLECTION_PREFIX: ""
  _BACKEND_TRAFFIC: "100"
  _FRONTEND_TRAFFIC: "100"

steps:
  - name: gcr.io/cloud-builders/docker
    id: build-backend-image
    args:
      - build
      - -f
      - backend/Dockerfile
      - -t
      - ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REPO}/backend:${SHORT_SHA}
      - backend

  - name: gcr.io/cloud-builders/docker
    id: build-frontend-image
    args:
      - build
      - -f
      - frontend/Dockerfile
      - -t
      - ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REPO}/frontend:${SHORT_SHA}
      - frontend

  - name: gcr.io/cloud-builders/docker
    id: push-backend-image
    args:
      - push
      - ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REPO}/backend:${SHORT_SHA}

  - name: gcr.io/cloud-builders/docker
    id: push-frontend-image
    args:
      - push
      - ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REPO}/frontend:${SHORT_SHA}

  - name: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
    id: deploy-cloud-run
    entrypoint: bash
    args:
      - -c
      - |
        set -euo pipefail

        BACKEND_IMAGE="${_REGION}-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REPO}/backend:${SHORT_SHA}"
        FRONTEND_IMAGE="${_REGION}-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REPO}/frontend:${SHORT_SHA}"

        BACKEND_SERVICE_ACCOUNT="${_BACKEND_SERVICE_ACCOUNT}"
        FRONTEND_SERVICE_ACCOUNT="${_FRONTEND_SERVICE_ACCOUNT}"
        BACKEND_SECRET_STATE="${_BACKEND_SECRET_STATE}"
        BACKEND_SECRET_CSRF="${_BACKEND_SECRET_CSRF}"
        BACKEND_SECRET_ADMIN_ALLOWED_EMAILS="${_BACKEND_SECRET_ADMIN_ALLOWED_EMAILS}"
        BACKEND_SECRET_ADMIN_ALLOWED_DOMAINS="${_BACKEND_SECRET_ADMIN_ALLOWED_DOMAINS}"

        if [[ -z "${BACKEND_SERVICE_ACCOUNT}" && -n "${FRONTEND_SERVICE_ACCOUNT}" ]]; then
          echo "Backend service account substitution missing. Reusing frontend service account." >&2
          BACKEND_SERVICE_ACCOUNT="${FRONTEND_SERVICE_ACCOUNT}"
        fi

        if [[ -z "${BACKEND_SERVICE_ACCOUNT}" ]]; then
          echo "Backend service account substitution is required." >&2
          exit 1
        fi

        if [[ -z "${FRONTEND_SERVICE_ACCOUNT}" ]]; then
          echo "Frontend service account substitution is required." >&2
          exit 1
        fi

        if [[ -z "${_BACKEND_SECRET_JWT}" ]]; then
          echo "Backend JWT secret substitution is required." >&2
          exit 1
        fi

        if [[ -z "${_BACKEND_SECRET_STATE}" ]]; then
          echo "Backend state secret substitution is required." >&2
          exit 1
        fi

        if [[ -z "${BACKEND_SECRET_CSRF}" && -n "${BACKEND_SECRET_STATE}" ]]; then
          echo "Backend CSRF secret substitution missing. Reusing backend state secret." >&2
          BACKEND_SECRET_CSRF="${BACKEND_SECRET_STATE}"
        fi

        if [[ -z "${_BACKEND_GOOGLE_CLIENT_ID}" ]]; then
          echo "Backend Google client ID substitution not provided. OAuth endpoints will be disabled." >&2
        fi

        if [[ -z "${_BACKEND_SECRET_GOOGLE_CLIENT_SECRET}" ]]; then
          echo "Backend Google client secret substitution is required." >&2
          exit 1
        fi

        if [[ -z "${BACKEND_SECRET_CSRF}" ]]; then
          echo "Backend CSRF secret substitution is required." >&2
          exit 1
        fi

        if [[ -z "${BACKEND_SECRET_ADMIN_ALLOWED_EMAILS}" ]]; then
          echo "Backend admin allowed emails secret substitution is required." >&2
          exit 1
        fi

        if [[ -z "${_FRONTEND_API_BASE_URL}" ]]; then
          echo "Frontend public API base URL substitution is required." >&2
          exit 1
        fi

        BACKEND_TRAFFIC="${_BACKEND_TRAFFIC:-100}"
        FRONTEND_TRAFFIC="${_FRONTEND_TRAFFIC:-100}"

        ensure_secret_ref() {
          local ref="$1"
          if [[ "${ref}" == *":"* ]]; then
            printf '%s' "${ref}"
          else
            printf '%s:latest' "${ref}"
          fi
        }

        is_secret_reference() {
          local candidate="$1"
          if [[ -z "${candidate}" ]]; then
            return 1
          fi
          if [[ "${candidate}" == projects/*/secrets/* ]]; then
            return 0
          fi
          if [[ "${candidate}" == sm://* ]]; then
            return 0
          fi
          if [[ "${candidate}" =~ ^[A-Za-z0-9_-]+(:[A-Za-z0-9_-]+)?$ ]]; then
            return 0
          fi
          return 1
        }

        escape_env_value() {
          local value="$1"
          value="${value//\\/\\\\}"
          value="${value//,/\\,}"
          value="${value//=/\\=}"
          printf '%s' "${value}"
        }

        append_env_var() {
          local key="$1"
          local value="$2"
          local escaped
          escaped="$(escape_env_value "${value}")"
          if [[ -z "${ENV_VARS_BACKEND}" ]]; then
            ENV_VARS_BACKEND="${key}=${escaped}"
          else
            ENV_VARS_BACKEND="${ENV_VARS_BACKEND},${key}=${escaped}"
          fi
        }

        require_secret_version() {
          local ref="$1"
          local identifier="${ref%:*}"
          local version="${ref##*:}"
          if [[ "${identifier}" == "${ref}" ]]; then
            identifier="${ref}"
            version="latest"
          fi

          local secret_project="${PROJECT_ID}"
          local secret_name="${identifier}"

          if [[ "${identifier}" == projects/*/secrets/* ]]; then
            local remainder="${identifier#projects/}"
            secret_project="${remainder%%/*}"
            secret_name="${remainder#*/secrets/}"
          fi

          if ! gcloud secrets versions describe "${version}" \
            --secret="${secret_name}" \
            --project="${secret_project}" \
            --quiet >/dev/null 2>&1; then
            echo "Error: Secret ${secret_project}/${secret_name} (version ${version}) is not accessible. Create it in Secret Manager or grant access." >&2
            exit 1
          fi
        }

        ENV_VARS_BACKEND="GIN_MODE=release,ENV=${_ENV},APP_FIRESTORE_PROJECT_ID=${PROJECT_ID},APP_FIRESTORE_DATABASE_ID=${_FIRESTORE_DATABASE_ID},APP_FIRESTORE_COLLECTION_PREFIX=${_FIRESTORE_COLLECTION_PREFIX},APP_GOOGLE_CLIENT_ID=${_BACKEND_GOOGLE_CLIENT_ID}"
        BACKEND_SECRET_JWT_REF="$(ensure_secret_ref "${_BACKEND_SECRET_JWT}")"
        BACKEND_SECRET_STATE_REF="$(ensure_secret_ref "${_BACKEND_SECRET_STATE}")"
        BACKEND_SECRET_CSRF_REF="$(ensure_secret_ref "${BACKEND_SECRET_CSRF}")"
        BACKEND_SECRET_GOOGLE_CLIENT_SECRET_REF="$(ensure_secret_ref "${_BACKEND_SECRET_GOOGLE_CLIENT_SECRET}")"

        require_secret_version "${BACKEND_SECRET_JWT_REF}"
        require_secret_version "${BACKEND_SECRET_STATE_REF}"
        require_secret_version "${BACKEND_SECRET_CSRF_REF}"
        require_secret_version "${BACKEND_SECRET_GOOGLE_CLIENT_SECRET_REF}"

        BACKEND_SET_SECRETS_LIST=(
          "APP_AUTH_JWT_SECRET=${BACKEND_SECRET_JWT_REF}"
          "APP_AUTH_STATE_SECRET=${BACKEND_SECRET_STATE_REF}"
          "APP_SECURITY_CSRF_SIGNING_KEY=${BACKEND_SECRET_CSRF_REF}"
          "APP_GOOGLE_CLIENT_SECRET=${BACKEND_SECRET_GOOGLE_CLIENT_SECRET_REF}"
        )
        BACKEND_UPDATE_SECRETS=()
        BACKEND_REMOVE_SECRETS=()

        if is_secret_reference "${BACKEND_SECRET_ADMIN_ALLOWED_EMAILS}"; then
          BACKEND_SECRET_ADMIN_ALLOWED_EMAILS_REF="$(ensure_secret_ref "${BACKEND_SECRET_ADMIN_ALLOWED_EMAILS}")"
          require_secret_version "${BACKEND_SECRET_ADMIN_ALLOWED_EMAILS_REF}"
          BACKEND_UPDATE_SECRETS+=("APP_AUTH_ADMIN_ALLOWED_EMAILS=${BACKEND_SECRET_ADMIN_ALLOWED_EMAILS_REF}")
        else
          echo "Info: BACKEND_SECRET_ADMIN_ALLOWED_EMAILS is treated as a literal value and will be injected via env vars." >&2
          append_env_var "APP_AUTH_ADMIN_ALLOWED_EMAILS" "${BACKEND_SECRET_ADMIN_ALLOWED_EMAILS}"
          BACKEND_REMOVE_SECRETS+=("APP_AUTH_ADMIN_ALLOWED_EMAILS")
        fi

        if [[ -n "${BACKEND_SECRET_ADMIN_ALLOWED_DOMAINS}" ]]; then
          if is_secret_reference "${BACKEND_SECRET_ADMIN_ALLOWED_DOMAINS}"; then
            BACKEND_SECRET_ADMIN_ALLOWED_DOMAINS_REF="$(ensure_secret_ref "${BACKEND_SECRET_ADMIN_ALLOWED_DOMAINS}")"
            require_secret_version "${BACKEND_SECRET_ADMIN_ALLOWED_DOMAINS_REF}"
            BACKEND_UPDATE_SECRETS+=("APP_AUTH_ADMIN_ALLOWED_DOMAINS=${BACKEND_SECRET_ADMIN_ALLOWED_DOMAINS_REF}")
          else
            echo "Info: BACKEND_SECRET_ADMIN_ALLOWED_DOMAINS is treated as a literal value and will be injected via env vars." >&2
            append_env_var "APP_AUTH_ADMIN_ALLOWED_DOMAINS" "${BACKEND_SECRET_ADMIN_ALLOWED_DOMAINS}"
            BACKEND_REMOVE_SECRETS+=("APP_AUTH_ADMIN_ALLOWED_DOMAINS")
          fi
        fi

        if [[ -n "${_BACKEND_SECRET_RECAPTCHA}" ]]; then
          BACKEND_SECRET_RECAPTCHA_REF="$(ensure_secret_ref "${_BACKEND_SECRET_RECAPTCHA}")"
          require_secret_version "${BACKEND_SECRET_RECAPTCHA_REF}"
          BACKEND_SET_SECRETS_LIST+=("G_RECAPTCHA_SECRET=${BACKEND_SECRET_RECAPTCHA_REF}")
        fi

        BACKEND_CMD=(
          gcloud run deploy "${_BACKEND_SERVICE}-${_ENV}"
          --project="$PROJECT_ID"
          --region="${_REGION}"
          --platform=managed
          --image="${BACKEND_IMAGE}"
          --service-account="${BACKEND_SERVICE_ACCOUNT}"
          --execution-environment=gen2
          --no-allow-unauthenticated
          --set-env-vars="${ENV_VARS_BACKEND}"
          --set-secrets="$(IFS=,; printf '%s' "${BACKEND_SET_SECRETS_LIST[*]}")"
          --set-traffic="latest=${BACKEND_TRAFFIC}"
          --quiet
          --max-instances=3
        )

        for update_secret in "${BACKEND_UPDATE_SECRETS[@]}"; do
          BACKEND_CMD+=(--update-secrets="${update_secret}")
        done

        if [[ -n "${_VPC_CONNECTOR}" ]]; then
          BACKEND_CMD+=(--vpc-connector="${_VPC_CONNECTOR}")
        fi

        BACKEND_CMD+=(--labels="service=${_BACKEND_SERVICE},stage=${_ENV},managed-by=cloud-build")

        if [[ ${#BACKEND_REMOVE_SECRETS[@]} -gt 0 ]]; then
          BACKEND_CMD+=(--remove-secrets="$(IFS=,; printf '%s' "${BACKEND_REMOVE_SECRETS[*]}")")
        fi

        "${BACKEND_CMD[@]}"

        if [[ -z "${BACKEND_SECRET_ADMIN_ALLOWED_DOMAINS}" ]]; then
          if ! gcloud run services update "${_BACKEND_SERVICE}-${_ENV}" \
            --project="$PROJECT_ID" \
            --region="${_REGION}" \
            --platform=managed \
            --remove-secrets="APP_AUTH_ADMIN_ALLOWED_DOMAINS" \
            --quiet; then
            echo "Warning: APP_AUTH_ADMIN_ALLOWED_DOMAINS secret removal skipped (likely not previously set)." >&2
          fi
        fi

        FRONTEND_CMD=(
          gcloud run deploy "${_FRONTEND_SERVICE}-${_ENV}"
          --project="$PROJECT_ID"
          --region="${_REGION}"
          --platform=managed
          --image="${FRONTEND_IMAGE}"
          --service-account="${FRONTEND_SERVICE_ACCOUNT}"
          --execution-environment=gen2
          --allow-unauthenticated
          --set-env-vars="ENV=${_ENV},VITE_API_BASE_URL=${_FRONTEND_API_BASE_URL}"
          --set-traffic="latest=${FRONTEND_TRAFFIC}"
          --quiet
        )

        if [[ -n "${_FRONTEND_SECRET_RECAPTCHA}" ]]; then
          FRONTEND_SECRET_RECAPTCHA_REF="$(ensure_secret_ref "${_FRONTEND_SECRET_RECAPTCHA}")"
          require_secret_version "${FRONTEND_SECRET_RECAPTCHA_REF}"
          FRONTEND_CMD+=(--set-secrets="VITE_RECAPTCHA_SECRET=${FRONTEND_SECRET_RECAPTCHA_REF}")
        fi

        FRONTEND_CMD+=(--labels="service=${_FRONTEND_SERVICE},stage=${_ENV},managed-by=cloud-build")

        "${FRONTEND_CMD[@]}"

images:
  - ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REPO}/backend:${SHORT_SHA}
  - ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REPO}/frontend:${SHORT_SHA}

# 修正箇所: 147行目 'set -euo pipefail' から 'u' を削除し 'set -eo pipefail' に変更
name: CI / CD

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: Target environment for manual deployment
        required: true
        default: staging
        type: choice
        options:
          - staging
          - production

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality:
    name: Lint / Test / Build
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      GO_VERSION: '1.22'
      NODE_VERSION: '20.11.1'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Set up pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.20.0
          run_install: false

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store/v10
          key: ${{ runner.os }}-pnpm-${{ hashFiles('frontend/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: make deps

      - name: Terraform validate
        working-directory: terraform/environments/dev
        run: |
          terraform init -backend=false
          terraform validate

      - name: Verify MySQL schema
        run: make db-verify

      - name: Run lint
        run: make lint

      - name: Run tests
        run: make test

      - name: Run build
        run: make build

  deploy:
    name: Deploy via Cloud Build
    needs: quality
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')
    permissions:
      contents: read
      id-token: write
    environment:
      name: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || 'staging' }}
    env:
      CLOUD_RUN_REGION: ${{ vars.CLOUD_RUN_REGION }}
      ARTIFACT_REPO: ${{ vars.CLOUD_BUILD_ARTIFACT_REPO }}
      ARTIFACT_REPO_LOCATION: ${{ vars.CLOUD_BUILD_ARTIFACT_LOCATION || vars.CLOUD_RUN_REGION }}
      BACKEND_SERVICE: ${{ vars.CLOUD_RUN_BACKEND_SERVICE }}
      FRONTEND_SERVICE: ${{ vars.CLOUD_RUN_FRONTEND_SERVICE }}
      VPC_CONNECTOR: ${{ vars.CLOUD_RUN_VPC_CONNECTOR }}
      BACKEND_SERVICE_ACCOUNT: ${{ vars.BACKEND_SERVICE_ACCOUNT_EMAIL || secrets.BACKEND_SERVICE_ACCOUNT_EMAIL }}
      FRONTEND_SERVICE_ACCOUNT: ${{ vars.FRONTEND_SERVICE_ACCOUNT_EMAIL || secrets.FRONTEND_SERVICE_ACCOUNT_EMAIL }}
      BACKEND_DB_DRIVER: ${{ vars.BACKEND_DB_DRIVER || '' }}
      FRONTEND_API_BASE_URL: ${{ vars.FRONTEND_API_BASE_URL || secrets.FRONTEND_API_BASE_URL }}
      FRONTEND_APP_BASE_URL: ${{ vars.FRONTEND_APP_BASE_URL || secrets.FRONTEND_APP_BASE_URL }}
      BACKEND_TRAFFIC_PERCENT: ${{ vars.BACKEND_TRAFFIC_PERCENT }}
      FRONTEND_TRAFFIC_PERCENT: ${{ vars.FRONTEND_TRAFFIC_PERCENT }}
      BACKEND_GOOGLE_CLIENT_ID: ${{ vars.BACKEND_GOOGLE_CLIENT_ID || secrets.BACKEND_GOOGLE_CLIENT_ID }}
      BACKEND_SECRET_JWT: ${{ secrets.BACKEND_SECRET_JWT }}
      BACKEND_SECRET_STATE: ${{ secrets.BACKEND_SECRET_STATE }}
      BACKEND_SECRET_CSRF: ${{ secrets.BACKEND_SECRET_CSRF }}
      BACKEND_SECRET_GOOGLE_CLIENT_SECRET: ${{ secrets.BACKEND_SECRET_GOOGLE_CLIENT_SECRET }}
      BACKEND_SECRET_RECAPTCHA: ${{ secrets.BACKEND_SECRET_RECAPTCHA }}
      BACKEND_SECRET_ADMIN_ALLOWED_EMAILS: ${{ secrets.BACKEND_SECRET_ADMIN_ALLOWED_EMAILS }}
      BACKEND_SECRET_ADMIN_ALLOWED_DOMAINS: ${{ secrets.BACKEND_SECRET_ADMIN_ALLOWED_DOMAINS }}
      FRONTEND_SECRET_RECAPTCHA: ${{ secrets.FRONTEND_SECRET_RECAPTCHA }}
      FIRESTORE_DATABASE_ID: ${{ vars.FIRESTORE_DATABASE_ID }}
      FIRESTORE_COLLECTION_PREFIX: ${{ vars.FIRESTORE_COLLECTION_PREFIX }}
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Install gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Build and Deploy
        env:
          DEPLOY_ENV: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || 'staging' }}
        run: |
          set -eo pipefail

          if [[ -z "${BACKEND_SERVICE_ACCOUNT:-}" && -n "${FRONTEND_SERVICE_ACCOUNT:-}" ]]; then
            echo "BACKEND_SERVICE_ACCOUNT is not set. Falling back to FRONTEND_SERVICE_ACCOUNT." >&2
            BACKEND_SERVICE_ACCOUNT="${FRONTEND_SERVICE_ACCOUNT}"
          fi

          if [[ -z "${BACKEND_SECRET_CSRF:-}" && -n "${BACKEND_SECRET_STATE:-}" ]]; then
            echo "BACKEND_SECRET_CSRF is not set. Falling back to BACKEND_SECRET_STATE." >&2
            BACKEND_SECRET_CSRF="${BACKEND_SECRET_STATE}"
          fi

          : "${CLOUD_RUN_REGION:?Missing CLOUD_RUN_REGION var}"
          : "${ARTIFACT_REPO:?Missing CLOUD_BUILD_ARTIFACT_REPO var}"
          : "${ARTIFACT_REPO_LOCATION:?Missing CLOUD_BUILD_ARTIFACT_LOCATION var}"
          : "${BACKEND_SERVICE:?Missing CLOUD_RUN_BACKEND_SERVICE var}"
          : "${FRONTEND_SERVICE:?Missing CLOUD_RUN_FRONTEND_SERVICE var}"
          : "${BACKEND_SERVICE_ACCOUNT:?Missing BACKEND_SERVICE_ACCOUNT_EMAIL var}"
          : "${FRONTEND_SERVICE_ACCOUNT:?Missing FRONTEND_SERVICE_ACCOUNT_EMAIL var}"
          : "${BACKEND_SECRET_JWT:?Missing BACKEND_SECRET_JWT secret}"
          : "${BACKEND_SECRET_STATE:?Missing BACKEND_SECRET_STATE secret}"
          : "${BACKEND_SECRET_CSRF:?Missing BACKEND_SECRET_CSRF secret}"
          : "${BACKEND_SECRET_ADMIN_ALLOWED_EMAILS:?Missing BACKEND_SECRET_ADMIN_ALLOWED_EMAILS secret}"

          if [[ -z "${BACKEND_GOOGLE_CLIENT_ID:-}" ]]; then
            echo "BACKEND_GOOGLE_CLIENT_ID is not set. Google OAuth endpoints will be disabled." >&2
          fi
          : "${BACKEND_SECRET_GOOGLE_CLIENT_SECRET:?Missing BACKEND_SECRET_GOOGLE_CLIENT_SECRET secret}"
          : "${FRONTEND_API_BASE_URL:?Missing FRONTEND_API_BASE_URL var}"
          FRONTEND_API_BASE_CANON="${FRONTEND_API_BASE_URL%/}"
          if [[ "${FRONTEND_API_BASE_CANON}" != */api && "${FRONTEND_API_BASE_CANON}" != */api/* ]]; then
            echo "Info: FRONTEND_API_BASE_URL does not include /api prefix. Appending automatically for SPA requests." >&2
            FRONTEND_API_BASE_CANON="${FRONTEND_API_BASE_CANON%/}/api"
          fi
          FRONTEND_API_BASE_CANON="${FRONTEND_API_BASE_CANON%/}"
          FRONTEND_PROXY_PASS="${FRONTEND_API_BASE_CANON}/"
          FRONTEND_ADMIN_LOGIN_URL="${FRONTEND_API_BASE_CANON}/admin/auth/login"
          BACKEND_GOOGLE_REDIRECT_URL="${FRONTEND_API_BASE_CANON}/admin/auth/callback"
          FRONTEND_APP_BASE_RAW="${FRONTEND_APP_BASE_URL%/}"
          if [[ -n "${FRONTEND_APP_BASE_RAW}" ]]; then
            FRONTEND_APP_BASE="${FRONTEND_APP_BASE_RAW%/admin}"
            FRONTEND_APP_BASE="${FRONTEND_APP_BASE%/}"
            if [[ -z "${FRONTEND_APP_BASE}" ]]; then
              BACKEND_ADMIN_DEFAULT_REDIRECT_URI="/admin"
            else
              BACKEND_ADMIN_DEFAULT_REDIRECT_URI="${FRONTEND_APP_BASE}/admin"
            fi
          else
            FRONTEND_APP_BASE="${FRONTEND_API_BASE_CANON%/api}"
            if [[ "${FRONTEND_APP_BASE}" == "${FRONTEND_API_BASE_CANON}" ]]; then
              FRONTEND_APP_BASE="${FRONTEND_API_BASE_CANON%/}"
            fi
            if [[ -z "${FRONTEND_APP_BASE}" ]]; then
              BACKEND_ADMIN_DEFAULT_REDIRECT_URI="/admin"
            else
              FRONTEND_APP_BASE="${FRONTEND_APP_BASE%/}"
              BACKEND_ADMIN_DEFAULT_REDIRECT_URI="${FRONTEND_APP_BASE}/admin"
            fi
          fi
          BACKEND_TRAFFIC="${BACKEND_TRAFFIC_PERCENT:-100}"
          FRONTEND_TRAFFIC="${FRONTEND_TRAFFIC_PERCENT:-100}"
          BACKEND_RECAPTCHA="${BACKEND_SECRET_RECAPTCHA:-}"
          FRONTEND_RECAPTCHA="${FRONTEND_SECRET_RECAPTCHA:-}"
          VPC_RAW="${VPC_CONNECTOR:-}"
          VPC_CANON="$(printf '%s' "${VPC_RAW}" | tr '[:upper:]' '[:lower:]')"
          if [[ -z "${VPC_CANON}" || "${VPC_CANON}" == "none" ]]; then
            VPC=""
          else
            VPC="${VPC_RAW}"
          fi
          FIRESTORE_DB="${FIRESTORE_DATABASE_ID:-(default)}"
          FIRESTORE_PREFIX="${FIRESTORE_COLLECTION_PREFIX:-}"

          SHORT_SHA="$(printf '%s' "${GITHUB_SHA}" | cut -c1-7)"
          ARTIFACT_HOST="${ARTIFACT_REPO_LOCATION}-docker.pkg.dev"
          BACKEND_IMAGE="${ARTIFACT_HOST}/${GCP_PROJECT_ID}/${ARTIFACT_REPO}/backend:${SHORT_SHA}"
          FRONTEND_IMAGE="${ARTIFACT_HOST}/${GCP_PROJECT_ID}/${ARTIFACT_REPO}/frontend:${SHORT_SHA}"

          gcloud auth configure-docker "${ARTIFACT_HOST}" --quiet

          if ! gcloud artifacts repositories describe "${ARTIFACT_REPO}" --location="${ARTIFACT_REPO_LOCATION}" >/dev/null 2>&1; then
            echo "Warning: Failed to describe Artifact Registry ${ARTIFACT_REPO_LOCATION}/${ARTIFACT_REPO}." >&2
            echo "Verify the repository exists and the workload identity principal has artifactregistry.repositories.get permission." >&2
          fi

          normalize_secret_ref() {
            local ref="$1"
            local raw="${ref}"
            local version=""

            if [[ "${raw}" == sm://* ]]; then
              raw="${raw#sm://}"
            fi

            # Remove common control characters that break secret resolution
            raw="${raw//$'\r'/}"
            raw="${raw//$'\n'/}"
            raw="${raw//$'\t'/}"

            if [[ "${raw}" == *":"* ]]; then
              version="${raw##*:}"
              raw="${raw%:*}"
            fi

            if [[ "${raw}" == */versions/* ]]; then
              local candidate_version="${raw##*/versions/}"
              if [[ -z "${version}" && -n "${candidate_version}" ]]; then
                version="${candidate_version}"
              fi
              raw="${raw%/versions/*}"
            fi

            local path="${raw}"
            if [[ "${path}" != projects/*/secrets/* ]]; then
              path="projects/${GCP_PROJECT_ID}/secrets/${path}"
            fi

            if [[ -z "${version}" ]]; then
              version="latest"
            fi

            printf '%s:%s' "${path}" "${version}"
          }

          is_secret_reference() {
            local candidate="$1"
            if [[ -z "${candidate}" ]]; then
              return 1
            fi
            if [[ "${candidate}" == projects/*/secrets/* ]]; then
              return 0
            fi
            if [[ "${candidate}" == sm://* ]]; then
              return 0
            fi
            # Allow secret names with versions, or just secret names (implies latest)
            if [[ "${candidate}" =~ ^[a-zA-Z0-9_-]+(:[a-zA-Z0-9_-]+)?$ ]]; then
              return 0
            fi
            return 1
          }

          escape_env_value() {
            local value="$1"
            value="${value//\\/\\\\}"
            value="${value//,/\\,}"
            value="${value//=/\\=}"
            printf '%s' "${value}"
          }

          append_env_var_to() {
            local list_name="$1"
            local key="$2"
            local value="$3"
            local escaped
            escaped="$(escape_env_value "${value}")"
            if [[ -z "${!list_name}" ]]; then
              printf -v "${list_name}" "%s=%s" "${key}" "${escaped}"
            else
              printf -v "${list_name}" "%s,%s=%s" "${!list_name}" "${key}" "${escaped}"
            fi
          }

          append_unique() {
            local list_name="$1"
            local value="$2"
            local -n list_ref="${list_name}"
            for existing in "${list_ref[@]}"; do
              if [[ "${existing}" == "${value}" ]]; then
                return 0
              fi
            done
            list_ref+=("${value}")
            return 0
          }

          append_backend_env_var() {
            append_env_var_to ENV_VARS_BACKEND "$1" "$2"
          }

          append_frontend_env_var() {
            append_env_var_to ENV_VARS_FRONTEND "$1" "$2"
          }

          add_secret_or_env() {
            local env_key="$1"
            local value="$2"
            local required_flag="${3:-true}"
            local required
            if [[ "${required_flag}" == "false" ]]; then
              required="false"
            else
              required="true"
            fi
            local var_ref="${4:-}"

            if [[ -z "${value}" ]]; then
              if [[ "${required}" == "true" ]]; then
                echo "Error: ${env_key} is required but not provided." >&2
                exit 1
              fi
              if [[ -n "${var_ref}" ]]; then
                printf -v "${var_ref}" ''
              fi
              append_unique BACKEND_REMOVE_SECRETS "${env_key}"
              append_unique BACKEND_REMOVE_ENV_VARS "${env_key}"
              return
            fi

            if is_secret_reference "${value}"; then
              local ref
              ref="$(normalize_secret_ref "${value}")"
              if ! require_secret_version "${ref}" "${required}"; then
                if [[ "${required}" == "true" ]]; then
                  exit 1
                fi
                if [[ -n "${var_ref}" ]]; then
                  printf -v "${var_ref}" ''
                fi
                append_unique BACKEND_REMOVE_SECRETS "${env_key}"
                append_unique BACKEND_REMOVE_ENV_VARS "${env_key}"
                return
              fi
              local run_ref
              run_ref="$(format_secret_for_gcloud_run "${ref}")"
              BACKEND_SECRETS_LIST+=("${env_key}=${run_ref}")
              append_unique BACKEND_REMOVE_ENV_VARS "${env_key}"
            else
              echo "Info: ${env_key} is treated as a literal value and will be injected via env vars." >&2
              append_backend_env_var "${env_key}" "${value}"
              append_unique BACKEND_REMOVE_SECRETS "${env_key}"
            fi
            return 0
          }

          require_secret_version() {
            local ref="$1"
            local required="${2:-true}"
            local normalized="${ref}"
            if [[ "${normalized}" != projects/*/secrets/*:* ]]; then
              normalized="$(normalize_secret_ref "${normalized}")"
            fi

            local path="${normalized%:*}"
            local version="${normalized##*:}"
            local remainder="${path#projects/}"
            local secret_project="${remainder%%/*}"
            local secret_name="${remainder#*/secrets/}"

            echo "Checking secret: ${secret_project}/${secret_name}"

            if ! gcloud secrets versions describe "${version}" \
              --secret="${secret_name}" \
              --project="${secret_project}" \
              --quiet >/dev/null 2>&1; then
              if [[ "${required}" == "true" ]]; then
                echo "Error: Secret ${secret_project}/${secret_name} (version ${version}) is not accessible. Create it in Secret Manager or grant access." >&2
              else
                echo "Warning: Secret ${secret_project}/${secret_name} (version ${version}) is not accessible. Skipping optional secret injection." >&2
              fi
              return 1
            fi
            return 0
          }

          format_secret_for_gcloud_run() {
            local ref="$1"
            local normalized="${ref}"
            if [[ "${normalized}" != projects/*/secrets/*:* ]]; then
              normalized="$(normalize_secret_ref "${normalized}")"
            fi

            local path="${normalized%:*}"
            local version="${normalized##*:}"
            local remainder="${path#projects/}"
            local secret_project="${remainder%%/*}"
            local secret_name="${remainder#*/secrets/}"
            local run_ref="${secret_name}:${version}"

            if [[ -n "${secret_project}" && "${secret_project}" != "${GCP_PROJECT_ID}" ]]; then
              run_ref="${run_ref}@${secret_project}"
            fi

            printf '%s' "${run_ref}"
          }

          docker build -f backend/Dockerfile -t "${BACKEND_IMAGE}" backend

          FRONTEND_BUILD_ARGS=(
            --build-arg "VITE_API_BASE_URL=${FRONTEND_API_BASE_CANON}"
            --build-arg "VITE_ADMIN_LOGIN_URL=${FRONTEND_ADMIN_LOGIN_URL}"
          )
          if [[ -n "${FRONTEND_ADMIN_SUPPORT_EMAIL:-}" ]]; then
            FRONTEND_BUILD_ARGS+=(--build-arg "VITE_ADMIN_SUPPORT_EMAIL=${FRONTEND_ADMIN_SUPPORT_EMAIL}")
          fi
          docker build "${FRONTEND_BUILD_ARGS[@]}" -f frontend/Dockerfile -t "${FRONTEND_IMAGE}" frontend

          docker push "${BACKEND_IMAGE}"
          docker push "${FRONTEND_IMAGE}"

          BACKEND_DB_DRIVER_CANON="$(printf '%s' "${BACKEND_DB_DRIVER:-}" | tr '[:upper:]' '[:lower:]')"
          if [[ -z "${BACKEND_DB_DRIVER_CANON}" ]]; then
            BACKEND_DB_DRIVER_CANON="firestore"
          fi

          ENV_VARS_BACKEND="GIN_MODE=release,ENV=${DEPLOY_ENV},APP_FIRESTORE_PROJECT_ID=${GCP_PROJECT_ID},APP_FIRESTORE_DATABASE_ID=${FIRESTORE_DB},APP_FIRESTORE_COLLECTION_PREFIX=${FIRESTORE_PREFIX},APP_GOOGLE_CLIENT_ID=${BACKEND_GOOGLE_CLIENT_ID},APP_GOOGLE_REDIRECT_URL=${BACKEND_GOOGLE_REDIRECT_URL},APP_ADMIN_REDIRECT_URI=${BACKEND_ADMIN_DEFAULT_REDIRECT_URI},APP_AUTH_ADMIN_DEFAULT_REDIRECT_URI=${BACKEND_ADMIN_DEFAULT_REDIRECT_URI},APP_SERVER_PORT=8080,APP_DB_DRIVER=${BACKEND_DB_DRIVER_CANON}"
          BACKEND_SECRETS_LIST=()
          BACKEND_REMOVE_SECRETS=()
          BACKEND_REMOVE_ENV_VARS=()

          add_secret_or_env "APP_AUTH_JWT_SECRET" "${BACKEND_SECRET_JWT}"
          add_secret_or_env "APP_AUTH_STATE_SECRET" "${BACKEND_SECRET_STATE}"
          add_secret_or_env "APP_SECURITY_CSRF_SIGNING_KEY" "${BACKEND_SECRET_CSRF}"
          add_secret_or_env "APP_GOOGLE_CLIENT_SECRET" "${BACKEND_SECRET_GOOGLE_CLIENT_SECRET}"
          add_secret_or_env "APP_AUTH_ADMIN_ALLOWED_EMAILS" "${BACKEND_SECRET_ADMIN_ALLOWED_EMAILS}"
          add_secret_or_env "APP_AUTH_ADMIN_ALLOWED_DOMAINS" "${BACKEND_SECRET_ADMIN_ALLOWED_DOMAINS:-}" "false" BACKEND_SECRET_ADMIN_ALLOWED_DOMAINS
          add_secret_or_env "G_RECAPTCHA_SECRET" "${BACKEND_RECAPTCHA:-}" "false" BACKEND_RECAPTCHA

          BACKEND_SECRETS=""
          if [[ ${#BACKEND_SECRETS_LIST[@]} -gt 0 ]]; then
            BACKEND_SECRETS_IFS="${IFS}"
            IFS=,
            BACKEND_SECRETS="${BACKEND_SECRETS_LIST[*]}"
            IFS="${BACKEND_SECRETS_IFS}"
            unset BACKEND_SECRETS_IFS
          fi

          BACKEND_SERVICE_NAME="${BACKEND_SERVICE}"
          if [[ "${BACKEND_SERVICE_NAME}" != *"-${DEPLOY_ENV}" ]]; then
            BACKEND_SERVICE_NAME="${BACKEND_SERVICE_NAME}-${DEPLOY_ENV}"
          fi

          FRONTEND_SERVICE_NAME="${FRONTEND_SERVICE}"
          if [[ "${FRONTEND_SERVICE_NAME}" != *"-${DEPLOY_ENV}" ]]; then
            FRONTEND_SERVICE_NAME="${FRONTEND_SERVICE_NAME}-${DEPLOY_ENV}"
          fi

          BACKEND_CMD=(
            gcloud run deploy "${BACKEND_SERVICE_NAME}"
            --project="${GCP_PROJECT_ID}"
            --region="${CLOUD_RUN_REGION}"
            --platform=managed
            --image="${BACKEND_IMAGE}"
            --service-account="${BACKEND_SERVICE_ACCOUNT}"
            --execution-environment=gen2
            --allow-unauthenticated
            --set-env-vars="${ENV_VARS_BACKEND}"
            --quiet
            --max-instances=3
            --labels="service=${BACKEND_SERVICE},stage=${DEPLOY_ENV},managed-by=github-actions"
          )

          if [[ -n "${BACKEND_SECRETS}" ]]; then
            BACKEND_CMD+=(--set-secrets="${BACKEND_SECRETS}")
          fi

          if [[ ${#BACKEND_REMOVE_SECRETS[@]} -gt 0 ]]; then
            BACKEND_CMD+=(--remove-secrets="$(IFS=,; printf '%s' "${BACKEND_REMOVE_SECRETS[*]}")")
          fi

          if [[ -n "${VPC}" ]]; then
            BACKEND_CMD+=(--vpc-connector="${VPC}")
          else
            BACKEND_CMD+=(--clear-vpc-connector)
          fi

          "${BACKEND_CMD[@]}"

          if [[ ${#BACKEND_REMOVE_ENV_VARS[@]} -gt 0 ]]; then
            BACKEND_REMOVE_ENV_VARS_JOINED="$(IFS=,; printf '%s' "${BACKEND_REMOVE_ENV_VARS[*]}")"
            if ! gcloud run services update "${BACKEND_SERVICE_NAME}" \
              --project="${GCP_PROJECT_ID}" \
              --region="${CLOUD_RUN_REGION}" \
              --platform=managed \
              --remove-env-vars="${BACKEND_REMOVE_ENV_VARS_JOINED}" \
              --quiet; then
              echo "Warning: APP env var cleanup (${BACKEND_REMOVE_ENV_VARS_JOINED}) skipped (likely not previously set)." >&2
            fi
          fi

          if [[ -z "${BACKEND_SECRET_ADMIN_ALLOWED_DOMAINS:-}" ]]; then
            if ! gcloud run services update "${BACKEND_SERVICE_NAME}" \
              --project="${GCP_PROJECT_ID}" \
              --region="${CLOUD_RUN_REGION}" \
              --platform=managed \
              --remove-secrets="APP_AUTH_ADMIN_ALLOWED_DOMAINS" \
              --quiet; then
              echo "Warning: APP_AUTH_ADMIN_ALLOWED_DOMAINS secret removal skipped (likely not previously set)." >&2
            fi
          fi

          if [[ "${BACKEND_TRAFFIC}" != "100" ]]; then
            echo "Warning: BACKEND_TRAFFIC_PERCENT=${BACKEND_TRAFFIC} is not currently applied. Update traffic manually via gcloud run services update-traffic." >&2
          fi

          ENV_VARS_FRONTEND="ENV=${DEPLOY_ENV},VITE_API_BASE_URL=${FRONTEND_API_BASE_CANON},API_PROXY_PASS=${FRONTEND_PROXY_PASS},VITE_ADMIN_LOGIN_URL=${FRONTEND_ADMIN_LOGIN_URL}"
          FRONTEND_SECRETS_ARGS=()

          if [[ -n "${FRONTEND_RECAPTCHA}" ]]; then
            if is_secret_reference "${FRONTEND_RECAPTCHA}"; then
              FRONTEND_SECRET_RECAPTCHA_REF="$(normalize_secret_ref "${FRONTEND_RECAPTCHA}")"
              if require_secret_version "${FRONTEND_SECRET_RECAPTCHA_REF}" false; then
                FRONTEND_SECRETS_ARGS+=(--set-secrets="VITE_RECAPTCHA_SECRET=$(format_secret_for_gcloud_run "${FRONTEND_SECRET_RECAPTCHA_REF}")")
              else
                FRONTEND_SECRETS_ARGS+=(--remove-secrets="VITE_RECAPTCHA_SECRET")
              fi
            else
              echo "Info: VITE_RECAPTCHA_SECRET is treated as a literal value and will be injected via env vars." >&2
              append_frontend_env_var "VITE_RECAPTCHA_SECRET" "${FRONTEND_RECAPTCHA}"
              FRONTEND_SECRETS_ARGS+=(--remove-secrets="VITE_RECAPTCHA_SECRET")
            fi
          fi

          FRONTEND_CMD=(
            gcloud run deploy "${FRONTEND_SERVICE_NAME}"
            --project="${GCP_PROJECT_ID}"
            --region="${CLOUD_RUN_REGION}"
            --platform=managed
            --image="${FRONTEND_IMAGE}"
            --service-account="${FRONTEND_SERVICE_ACCOUNT}"
            --execution-environment=gen2
            --allow-unauthenticated
            --set-env-vars="${ENV_VARS_FRONTEND}"
            --quiet
            --labels="service=${FRONTEND_SERVICE},stage=${DEPLOY_ENV},managed-by=github-actions"
          )

          if [[ -n "${VPC}" ]]; then
            FRONTEND_CMD+=(--vpc-connector="${VPC}")
          else
            FRONTEND_CMD+=(--clear-vpc-connector)
          fi

          if [[ ${#FRONTEND_SECRETS_ARGS[@]} -gt 0 ]]; then
            FRONTEND_CMD+=("${FRONTEND_SECRETS_ARGS[@]}")
          fi

          "${FRONTEND_CMD[@]}"

          if [[ "${FRONTEND_TRAFFIC}" != "100" ]]; then
            echo "Warning: FRONTEND_TRAFFIC_PERCENT=${FRONTEND_TRAFFIC} is not currently applied. Update traffic manually via gcloud run services update-traffic." >&2
          fi
